<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>טופס חלבונים – לפי מנות</title>
  <!-- Tailwind (CDN), React 18 (UMD), Babel for JSX -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { boxShadow: { glow: '0 10px 40px rgba(0,0,0,.08)' } } } };
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Removed react-dom-client (not needed). Use ReactDOM.createRoot directly. -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body{min-height:100vh}
    .glass{backdrop-filter:saturate(180%) blur(8px)}
  </style>
</head>
<body class="bg-gradient-to-b from-rose-50 via-fuchsia-50 to-sky-50 text-slate-900 min-h-screen">
  <div id="root"></div>

  <!-- Ensure Babel transforms JSX properly -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo } = React;

    // ===== i18n =====
    const LANGS = {
      he: {
        appTitle: 'טופס חלבונים – לפי מנות',
        subtitle: 'מנה = יחידה אחת. נשמר אוטומטית בדפדפן.',
        date: 'תאריך',
        search: 'חיפוש…',
        clear: 'ניקוי',
        proteins: 'חלבונים',
        addCustom: '+ פריט מותאם',
        nameCol: 'שם',
        qtyCol: 'מנות',
        unit: 'מנות',
        total: 'סה"כ',
        note: 'הערה',
        generalNote: 'הערה כללית',
        share: 'שליחה בווצאפ',
        copy: 'העתקה ללוח',
        resetAll: 'איפוס מלא',
        resetCat: 'איפוס קטגוריה',
        shortages: 'חוסרים',
        jumpToInput: 'קפיצה לקלט',
        version: 'גרסה: חלבונים v1',
        emoji: { proteins: '🍢' },
      },
      en: {
        appTitle: 'Protein Inventory – Portions',
        subtitle: '1 portion = one unit. Auto-saved in the browser.',
        date: 'Date',
        search: 'Search…',
        clear: 'Clear',
        proteins: 'Proteins',
        addCustom: '+ Custom item',
        nameCol: 'Name',
        qtyCol: 'Portions',
        unit: 'portions',
        total: 'Total',
        note: 'Note',
        generalNote: 'General note',
        share: 'Send via WhatsApp',
        copy: 'Copy',
        resetAll: 'Reset all',
        resetCat: 'Reset category',
        shortages: 'Shortages',
        jumpToInput: 'Jump to input',
        version: 'Version: Proteins v1',
        emoji: { proteins: '🍢' },
      },
      zh: {
        appTitle: '蛋白类清单（按份数）',
        subtitle: '1 份 = 1 单位。自动保存在浏览器。',
        date: '日期',
        search: '搜索…',
        clear: '清除',
        proteins: '蛋白类',
        addCustom: '+ 自定义项目',
        nameCol: '名称',
        qtyCol: '份数',
        unit: '份',
        total: '合计',
        note: '备注',
        generalNote: '总体备注',
        share: '通过 WhatsApp 发送',
        copy: '复制',
        resetAll: '全部重置',
        resetCat: '重置分类',
        shortages: '缺货',
        jumpToInput: '跳到输入',
        version: '版本：蛋白类 v1',
        emoji: { proteins: '🍢' },
      },
    };

    // ===== Items (Hebrew keys) =====
    const DEFAULT_ITEMS = [
      'סלמון',
      'שיפוד לשון',
      'קבב ברווז',
      'בר ים קאטצו',
      'שיפוד פיקניה',
      'שיפוד טורו',
      'שיפוד ברוקולי',
      'שיפוד פטריה',
      'גיוזה',
      'שרימפס',
      'פילה דג',
      'נתח בקר',
      'טופו',
      'תירס',
      'אספרגוס',
    ];

    // English mapping
    const NAME_MAP_EN = {
      'סלמון': 'Salmon',
      'שיפוד לשון': 'Beef Tongue Skewer',
      'קבב ברווז': 'Duck Kebab',
      'בר ים קאטצו': 'Sea Bass Katsu',
      'שיפוד פיקניה': 'Picanha Skewer',
      'שיפוד טורו': 'Toro Skewer',
      'שיפוד ברוקולי': 'Broccoli Skewer',
      'שיפוד פטריה': 'Mushroom Skewer',
      'גיוזה': 'Gyoza',
      'שרימפס': 'Shrimp',
      'פילה דג': 'Fish Fillet',
      'נתח בקר': 'Beef Cut',
      'טופו': 'Tofu',
      'תירס': 'Corn',
      'אספרגוס': 'Asparagus',
    };

    // Chinese mapping (简体)
    const NAME_MAP_ZH = {
      'סלמון': '三文鱼',
      'שיפוד לשון': '牛舌串',
      'קבב ברווז': '鸭肉烤串',
      'בר ים קאטצו': '海鲈鱼炸排',
      'שיפוד פיקניה': '巴西烤牛臀盖串',
      'שיפוד טורו': '金枪鱼腹肉串',
      'שיפוד ברוקולי': '西兰花串',
      'שיפוד פטריה': '蘑菇串',
      'גיוזה': '煎饺',
      'שרימפס': '虾',
      'פילה דג': '鱼柳',
      'נתח בקר': '牛肉块',
      'טופו': '豆腐',
      'תירס': '玉米',
      'אספרגוס': '芦笋',
    };

    function displayName(heName, lang){
      if(lang==='en') return NAME_MAP_EN[heName] || heName;
      if(lang==='zh') return NAME_MAP_ZH[heName] || heName;
      return heName;
    }

    const LS_KEY = 'protein-form-v1';

    function initialState(){
      const items = Object.fromEntries(DEFAULT_ITEMS.map(n => [n, 0]));
      return {
        meta: { date: new Date().toISOString().slice(0,10) },
        lang: 'he',
        search: '',
        items,
        custom: [], // {name, amount}
        notes: { general: '' },
      };
    }

    function App(){
      const [state, setState] = useState(()=>{
        try{const raw=localStorage.getItem(LS_KEY); return raw? JSON.parse(raw): initialState();}catch{ return initialState(); }
      });
      useEffect(()=>{ localStorage.setItem(LS_KEY, JSON.stringify(state)); },[state]);

      const langKey = (state.lang in LANGS)? state.lang: 'he';
      const t = LANGS[langKey];
      useEffect(()=>{ document.documentElement.setAttribute('dir', langKey==='he'?'rtl':'ltr'); document.documentElement.setAttribute('lang', langKey); },[langKey]);

      const [q, setQ] = useState('');
      useEffect(()=>{ const id=setTimeout(()=> setState(s=>({...s, search:q})), 180); return ()=> clearTimeout(id); },[q]);

      const matches = (heName)=>{
        if(!state.search) return true;
        const needle = state.search.toLowerCase();
        return heName.toLowerCase().includes(needle) || displayName(heName, langKey).toLowerCase().includes(needle);
      };

      const updateAmount = (name, v)=> setState(s=> ({...s, items:{...s.items, [name]: Math.max(0, Math.round(Number(v)||0)}}));
      const addCustom = ()=> setState(s=> ({...s, custom:[...s.custom, {name:'', amount:0}]}));
      const setCustom = (idx,k,v)=> setState(s=> { const arr=[...s.custom]; arr[idx] = {...arr[idx], [k]: k==='amount'? Math.max(0, Math.round(Number(v)||0)) : v }; return {...s, custom:arr}; });
      const removeCustom = (idx)=> setState(s=> ({...s, custom: s.custom.filter((_,i)=> i!==idx)}));
      const resetAll = ()=> setState(initialState());

      const shareText = useMemo(()=> formatShareText(state), [state]);
      const doCopy = async()=>{ try{ await navigator.clipboard.writeText(shareText); alert(langKey==='he'? 'הועתק ללוח.' : langKey==='zh'? '已复制到剪贴板。' : 'Copied.'); }catch{ alert('Copy failed.'); } };
      const doShare = ()=>{ const url = `https://wa.me/?text=${encodeURIComponent(shareText)}`; window.open(url,'_blank'); };

      return (
        <div className="max-w-xl mx-auto px-3 py-4">
          <header className="sticky top-0 z-10 mb-4 flex items-center justify-between gap-3 bg-white/70 glass rounded-2xl px-3 py-2 shadow-glow">
            <div className="py-1">
              <h1 className="text-2xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-rose-600">{t.appTitle}</h1>
              <p className="text-xs text-slate-600">{t.subtitle}</p>
            </div>
            <button onClick={()=> setState(s=>({...s, lang: s.lang==='he'?'en': s.lang==='en'?'zh':'he'}))} className="rounded-full border border-slate-300 px-3 py-1 text-sm bg-white shadow hover:shadow-md transition">{langKey==='he'?'EN': langKey==='en'?'中文':'HE'}</button>
          </header>

          {/* Date + Search */}
          <section className="grid grid-cols-1 gap-3 mb-4">
            <label className="flex flex-col gap-1">
              <span className="text-sm">{t.date}</span>
              <input type="date" value={state.meta.date} onChange={(e)=> setState(s=>({...s, meta:{...s.meta, date:e.target.value}}))} className="rounded-2xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500 bg-white shadow-glow" />
            </label>
            <div className="flex items-center gap-2 flex-wrap">
              <div className="flex-1 rounded-full border border-slate-200 bg-white px-4 py-2 shadow-glow focus-within:ring-2 focus-within:ring-indigo-500">
                <div className="flex items-center gap-2">
                  <span className="opacity-70">🔎</span>
                  <input placeholder={t.search} value={q} onChange={(e)=> setQ(e.target.value)} className="w-full focus:outline-none bg-transparent" />
                  {q && <button onClick={()=> setQ('')} className="text-xs opacity-70 hover:opacity-100">{t.clear}</button>}
                </div>
              </div>
            </div>
          </section>

          {/* Proteins category */}
          <section className={`mb-4 rounded-3xl border border-indigo-200 bg-gradient-to-br from-indigo-100 via-sky-100 to-rose-100 p-3 shadow-glow`}>
            <div className="flex items-center justify-between gap-2 mb-2">
              <h2 className="text-lg font-semibold"><span className={`inline-flex items-center px-3 py-1 rounded-2xl bg-gradient-to-r from-indigo-500 to-rose-500 text-white shadow text-sm`}>{t.proteins} {LANGS[langKey].emoji.proteins}</span></h2>
              <button onClick={()=> setState(s=> ({...s, items:Object.fromEntries(Object.keys(s.items).map(k=>[k,0])), custom:[], notes:{...s.notes}}))} className="text-xs underline opacity-70 hover:opacity-100">{t.resetCat}</button>
            </div>
            <div className="flex items-center justify-between text-xs text-slate-600 px-1 mb-1"><span>{t.nameCol}</span><span>{t.qtyCol}</span></div>
            <ul className="space-y-3">
              {Object.keys(state.items).filter(matches).map((heName)=> (
                <li key={heName} className="bg-white/95 rounded-2xl border border-slate-200 px-3 py-3 shadow-glow">
                  <div className="flex items-center gap-2 flex-wrap">
                    <div className="flex-1 min-w-[60%] sm:min-w-[50%]">
                      <div className="font-semibold whitespace-normal break-words leading-tight">{displayName(heName, langKey)}</div>
                      {langKey!=='he' && <div className="text-xs text-indigo-700 opacity-80 whitespace-normal break-words">{heName}</div>}
                    </div>
                    <Qty value={state.items[heName]} onChange={(v)=> updateAmount(heName,v)} t={t} />
                  </div>
                </li>
              ))}

              {state.custom.filter(r=> (r.name||'').trim()!=='' && matches(r.name)).map((row,idx)=> (
                <li key={`c-${idx}`} className="bg-white/95 rounded-2xl border border-slate-200 px-3 py-3 shadow-glow">
                  <div className="flex items-center gap-2 flex-wrap">
                    <input placeholder={t.addCustom.replace('+ ','')} value={row.name} onChange={(e)=> setCustom(idx,'name', e.target.value)} className="flex-1 min-w-[60%] sm:min-w-[50%] rounded-xl border border-slate-300 px-2 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <Qty value={row.amount} onChange={(v)=> setCustom(idx,'amount', v)} t={t} />
                    <button onClick={()=> removeCustom(idx)} className="text-xs px-2 py-1 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">{t.clear}</button>
                  </div>
                </li>
              ))}
            </ul>

            <div className="mt-2 flex gap-2">
              <button onClick={addCustom} className={`rounded-xl px-3 py-2 text-sm font-medium bg-gradient-to-r from-indigo-600 to-rose-600 text-white hover:brightness-110 transition`}>{t.addCustom}</button>
              <button onClick={()=> focusFirstNumber()} className={`rounded-xl px-3 py-2 text-sm font-medium border border-indigo-200 bg-white`}>{t.jumpToInput}</button>
            </div>
          </section>

          {/* Notes + actions */}
          <section className="mt-4">
            <label className="flex flex-col gap-1">
              <span className="text-sm">{t.generalNote}</span>
              <textarea rows={3} value={state.notes.general} onChange={(e)=> setState(s=>({...s, notes:{...s.notes, general:e.target.value}}))} className="rounded-2xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" />
            </label>
            <div className="mt-4 grid grid-cols-2 gap-3">
              <button onClick={doShare} className="rounded-2xl px-4 py-3 font-medium bg-slate-900 text-white shadow hover:shadow-md hover:opacity-90">{t.share}</button>
              <button onClick={doCopy} className="rounded-2xl px-4 py-3 font-medium border border-slate-300 bg-white shadow hover:shadow-md">{t.copy}</button>
              <button onClick={resetAll} className="col-span-2 rounded-2xl px-4 py-3 font-medium border border-rose-300 text-rose-700 bg-white hover:bg-rose-50">{t.resetAll}</button>
            </div>
          </section>

          <footer className="text-center text-xs text-slate-500 mt-6 mb-2">{t.version}</footer>
        </div>
      );
    }

    function Qty({ value, onChange, t }){
      const v = Number.isFinite(value)? value: 0;
      return (
        <div className="flex items-center gap-1 rounded-2xl border px-3 py-2 bg-white/90 shadow-glow min-w-[140px] justify-between select-none">
          <div className="text-xs opacity-80 mr-1">🍽️ {t.qtyCol}</div>
          <div className="flex items-center gap-1">
            <button type="button" className="px-3 py-1.5 rounded-full border hover:bg-slate-50" onClick={()=> onChange(Math.max(0, v-1))}>–</button>
            <input inputMode="numeric" pattern="[0-9]*" value={v} onChange={(e)=> onChange(Math.max(0, parseInt(e.target.value.replace(/[^0-9]/g,''))||0))} className="w-14 text-center rounded-lg border px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <button type="button" className="px-3 py-1.5 rounded-full text-white bg-gradient-to-r from-indigo-600 to-rose-600 hover:brightness-110" onClick={()=> onChange(v+1)}>+</button>
          </div>
        </div>
      );
    }

    function focusFirstNumber(){ const el = document.querySelector('input[inputmode="numeric"]'); el && el.focus(); }

    function formatShareText(state){
      const lang = (state.lang in LANGS)? state.lang : 'he';
      const t = LANGS[lang];
      const lines = [];
      lines.push(`${t.appTitle} – ${state.meta.date}`);
      lines.push('');
      // body: only >0
      const nz = Object.keys(state.items).filter(k=> Number(state.items[k])>0);
      const customNZ = (state.custom||[]).filter(r=> r.name && Number(r.amount)>0);
      if(nz.length || customNZ.length){
        lines.push(`${t.proteins}:`);
        nz.forEach(he=> lines.push(`• ${displayName(he, lang)} – ${state.items[he]} ${t.unit}`));
        customNZ.forEach(r=> lines.push(`• ${r.name} – ${r.amount} ${t.unit}`));
        lines.push('');
      }
      // shortages
      const shortage=[];
      Object.keys(state.items).forEach(k=>{ if(!Number(state.items[k])) shortage.push(`• ${displayName(k, lang)}`)});
      (state.custom||[]).forEach(r=>{ if(r.name && !Number(r.amount)) shortage.push(`• ${r.name}`)});
      if(shortage.length){ lines.push(`${t.shortages}:`); lines.push(...shortage); }
      return lines.join('\n');
    }

    // mount (use React 18 API directly). Fallback to legacy if needed.
    (function mount(){
      const container = document.getElementById('root');
      try {
        if (!container) throw new Error('root-missing');
        if (ReactDOM && typeof ReactDOM.createRoot === 'function') {
          const root = ReactDOM.createRoot(container);
          root.render(<App />);
        } else {
          // Legacy fallback: behave like React 17
          ReactDOM.render(<App />, container);
        }
      } catch (e) {
        console.error('Mount failed:', e);
      }
    })();

    // self-tests (do not change existing; add a few more)
    (function(){
      try{
        const base = initialState();
        const a = formatShareText(base);
        console.assert(/Shortages|缺货|חוסרים/.test(a), 'share text contains shortages title');
        const s = initialState(); s.items['סלמון']=2; const b = formatShareText(s); console.assert(b.includes('2'), 'portion count rendered');
        // New: language display mapping
        console.assert(displayName('סלמון','en')==='Salmon', 'EN mapping works');
        console.assert(displayName('סלמון','zh')==='三文鱼', 'ZH mapping works');
        console.assert(typeof ReactDOM.createRoot === 'function' || typeof ReactDOM.render === 'function', 'React DOM API available');
      }catch(e){ console.warn('Self-tests failed', e); }
    })();
  </script>
</body>
</html>
