<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Form</title>
    <!-- React 18 + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom-client.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <!-- TailwindCSS from CDN (precompiled) -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      /* Direction classes apply direction to children to support RTL/LTR */
      .rtl > * {
        direction: rtl;
      }
      .ltr > * {
        direction: ltr;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React Application Script -->
    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // Translation strings for Hebrew (he) and English (en)
      const LANGS = {
        he: {
          title: "טופס מלאי יומי",
          subtitle: "קלט בליטרים/קופסאות. נשמר אוטומטית.",
          date: "תאריך",
          notesLabel: "הערות כלליות",
          search: "חיפוש",
          clear: "נקה",
          cold: "פס קר",
          hot: "פס חם",
          nines: "תשיעיות",
          custom: "פריטים נוספים",
          addItem: "הוסף פריט",
          namePlaceholder: "שם הפריט…",
          categoryPlaceholder: "קטגוריה",
          boxes: "קופסאות 2 ל׳",
          liters: "ליטרים",
          total: "סה\"כ",
          language: "שפה",
          hebrew: "עברית",
          english: "English",
          share: "שלח לווטסאפ",
          shortages: "חוסרים",
          add: "הוסף",
        },
        en: {
          title: "Daily Inventory Form",
          subtitle: "Input in liters/boxes. Autosaved.",
          date: "Date",
          notesLabel: "General Notes",
          search: "Search",
          clear: "Clear",
          cold: "Cold Station",
          hot: "Hot Station",
          nines: "Nines",
          custom: "Additional Items",
          addItem: "Add Item",
          namePlaceholder: "Item name…",
          categoryPlaceholder: "Category",
          boxes: "2 L boxes",
          liters: "Liters",
          total: "Total",
          language: "Language",
          hebrew: "Hebrew",
          english: "English",
          share: "Share via WhatsApp",
          shortages: "Shortages",
          add: "Add",
        },
      };

      // Mapping of Hebrew item names to English equivalents
      const NAME_MAP_EN = {
        "גומה דארה": "Goma Dare",
        "קצואובושי טסויו": "Katsuobushi Tsuyu",
        "רוטב כרוב": "Cabbage Sauce",
        "שומר סונומונו": "Fennel Sunomono",
        "וואפו": "Wafu",
        "פונזו": "Ponzu",
        "אוממי מיקס": "Umami Mix",
        "מזלי קארי": "Mazli Curry",
        "בייס שיטאקי": "Shiitake Base",
        "קומבו דאשי": "Kombu Dashi",
        "צ׳ילי אוממי": "Umami Chili",
      };

      // Initial inventory items: name and category
      const INITIAL_ITEMS = [
        { name: "גומה דארה", cat: "cold" },
        { name: "קצואובושי טסויו", cat: "cold" },
        { name: "רוטב כרוב", cat: "cold" },
        { name: "שומר סונומונו", cat: "cold" },
        { name: "וואפו", cat: "cold" },
        { name: "אוממי מיקס", cat: "cold" },
        { name: "מזלי קארי", cat: "hot" },
        { name: "בייס שיטאקי", cat: "hot" },
        { name: "פונזו", cat: "cold" },
        { name: "קומבו דאשי", cat: "hot" },
        { name: "צ׳ילי אוממי", cat: "hot" },
      ];

      // Helper to compute total liters from liters + boxes
      function computeTotalLiters(item) {
        return item.liters + item.boxes * 2;
      }

      function InventoryForm() {
        const [lang, setLang] = useState(() => localStorage.getItem('lang') || 'he');
        const [items, setItems] = useState(() => {
          const saved = localStorage.getItem('items');
          if (saved) {
            try {
              return JSON.parse(saved);
            } catch (e) {
              // ignore
            }
          }
          const initObj = {};
          INITIAL_ITEMS.forEach((item) => {
            initObj[item.name] = { liters: 0, boxes: 0, cat: item.cat };
          });
          return initObj;
        });
        const [date, setDate] = useState(() => localStorage.getItem('date') || new Date().toISOString().split('T')[0]);
        const [notes, setNotes] = useState(() => localStorage.getItem('notes') || '');
        const [search, setSearch] = useState('');
        const [newItemName, setNewItemName] = useState('');
        const [newItemCat, setNewItemCat] = useState('cold');

        // Persist state changes
        useEffect(() => {
          localStorage.setItem('items', JSON.stringify(items));
        }, [items]);
        useEffect(() => {
          localStorage.setItem('date', date);
        }, [date]);
        useEffect(() => {
          localStorage.setItem('notes', notes);
        }, [notes]);
        useEffect(() => {
          localStorage.setItem('lang', lang);
        }, [lang]);

        // Filter names based on search term
        const filteredNames = useMemo(() => {
          const term = search.trim().toLowerCase();
          if (!term) return Object.keys(items);
          return Object.keys(items).filter((name) => {
            const en = NAME_MAP_EN[name] || '';
            return name.toLowerCase().includes(term) || en.toLowerCase().includes(term);
          });
        }, [items, search]);

        // Group items by category
        const groupedItems = useMemo(() => {
          const groups = { cold: [], hot: [], nines: [], custom: [] };
          Object.entries(items).forEach(([name, data]) => {
            if (!filteredNames.includes(name)) return;
            const cat = data.cat || 'custom';
            if (!groups[cat]) groups[cat] = [];
            groups[cat].push({ name, data });
          });
          return groups;
        }, [items, filteredNames]);

        // Adjust quantity of an item
        const changeQuantity = (name, field, delta) => {
          setItems((prev) => {
            const item = prev[name];
            const newValue = Math.max(0, parseFloat((item[field] + delta).toFixed(2)));
            return { ...prev, [name]: { ...item, [field]: newValue } };
          });
        };

        // Add new item
        const handleAddItem = () => {
          const trimmed = newItemName.trim();
          if (!trimmed) return;
          if (items[trimmed]) {
            alert('Item already exists');
            return;
          }
          setItems((prev) => ({ ...prev, [trimmed]: { liters: 0, boxes: 0, cat: newItemCat } }));
          setNewItemName('');
        };

        // Share via WhatsApp
        const handleShare = () => {
          const l = LANGS[lang];
          const lines = [];
          if (date) lines.push(`${l.date}: ${date}`);
          Object.entries(items).forEach(([name, data]) => {
            const total = computeTotalLiters(data);
            if (total > 0) {
              const dName = lang === 'en' ? NAME_MAP_EN[name] || name : name;
              lines.push(`${dName}: ${total} ${lang === 'he' ? "ל׳" : 'L'}`);
            }
          });
          if (notes.trim()) lines.push(`${l.notesLabel}: ${notes.trim()}`);
          const shortages = Object.entries(items).filter(([_, data]) => computeTotalLiters(data) === 0).map(([name]) => {
            return lang === 'en' ? NAME_MAP_EN[name] || name : name;
          });
          if (shortages.length) {
            lines.push('');
            lines.push(`${l.shortages}:`);
            shortages.forEach((n) => lines.push(`- ${n}`));
          }
          const text = lines.join('\n');
          window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        const l = LANGS[lang];
        const dirClass = lang === 'he' ? 'rtl' : 'ltr';

        return (
          <div className={`${dirClass} min-h-screen bg-gradient-to-b from-violet-50 via-slate-50 to-pink-50 text-gray-900 p-4 sm:p-6`}>
            <div className="max-w-4xl mx-auto space-y-4">
              {/* Header */}
              <div className="text-center">
                <h1 className="text-3xl font-bold mb-1">{l.title}</h1>
                <p className="text-gray-600">{l.subtitle}</p>
              </div>
              {/* Date & language */}
              <div className="flex flex-wrap items-center gap-4 justify-between">
                <div className="flex items-center gap-2">
                  <label htmlFor="date-input" className="font-medium whitespace-nowrap">{l.date}:</label>
                  <input
                    id="date-input"
                    type="date"
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                    className="border border-gray-300 rounded-lg px-2 py-1"
                  />
                </div>
                <div className="flex items-center gap-2 ml-auto">
                  <span className="font-medium whitespace-nowrap">{l.language}:</span>
                  <button
                    className={`px-3 py-1 rounded-lg border ${lang === 'he' ? 'bg-indigo-500 text-white' : 'bg-gray-200'}`}
                    onClick={() => setLang('he')}
                  >
                    {l.hebrew}
                  </button>
                  <button
                    className={`px-3 py-1 rounded-lg border ${lang === 'en' ? 'bg-indigo-500 text-white' : 'bg-gray-200'}`}
                    onClick={() => setLang('en')}
                  >
                    {l.english}
                  </button>
                </div>
              </div>
              {/* Search & notes */}
              <div className="flex flex-col gap-4 sm:flex-row sm:items-end">
                <div className="flex-1">
                  <label htmlFor="search-input" className="block font-medium mb-1">{l.search}:</label>
                  <input
                    id="search-input"
                    type="text"
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    placeholder={l.search}
                    className="w-full border border-gray-300 rounded-lg px-3 py-1"
                  />
                </div>
                <div className="flex-1">
                  <label htmlFor="notes-input" className="block font-medium mb-1">{l.notesLabel}:</label>
                  <textarea
                    id="notes-input"
                    rows="2"
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    placeholder={l.notesLabel}
                    className="w-full border border-gray-300 rounded-lg px-3 py-1 resize-y"
                  ></textarea>
                </div>
              </div>
              {/* Inventory groups */}
              {['cold','hot','nines','custom'].map((cat) => {
                const list = groupedItems[cat] || [];
                if (!list.length) return null;
                let bgColor = '';
                if (cat === 'cold') bgColor = 'bg-blue-100';
                else if (cat === 'hot') bgColor = 'bg-red-100';
                else if (cat === 'nines') bgColor = 'bg-green-100';
                else bgColor = 'bg-purple-100';
                const titleKey = cat === 'cold' ? 'cold' : cat === 'hot' ? 'hot' : cat === 'nines' ? 'nines' : 'custom';
                return (
                  <div key={cat} className="rounded-xl shadow-md overflow-hidden">
                    <div className={`${bgColor} px-4 py-2 font-semibold`}>{l[titleKey]}</div>
                    <div className="divide-y divide-gray-200">
                      {list.map(({ name, data }) => {
                        const displayName = lang === 'en' ? NAME_MAP_EN[name] || name : name;
                        return (
                          <div key={name} className="flex flex-wrap items-center gap-2 px-4 py-2">
                            <span className="flex-1 break-words font-medium" style={{minWidth:'40%'}}>{displayName}</span>
                            <div className="flex items-center space-x-1 rtl:space-x-reverse">
                              <button
                                onClick={() => changeQuantity(name, 'boxes', -1)}
                                disabled={data.boxes === 0}
                                className="px-2 py-1 bg-gray-200 rounded-full disabled:opacity-50"
                              >-</button>
                              <span className="w-6 text-center">{data.boxes}</span>
                              <button
                                onClick={() => changeQuantity(name, 'boxes', 1)}
                                className="px-2 py-1 bg-gray-200 rounded-full"
                              >+</button>
                              <span className="text-sm">{l.boxes}</span>
                            </div>
                            <div className="flex items-center space-x-1 rtl:space-x-reverse">
                              <button
                                onClick={() => changeQuantity(name, 'liters', -0.5)}
                                disabled={data.liters === 0}
                                className="px-2 py-1 bg-gray-200 rounded-full disabled:opacity-50"
                              >-</button>
                              <span className="w-6 text-center">{data.liters}</span>
                              <button
                                onClick={() => changeQuantity(name, 'liters', 0.5)}
                                className="px-2 py-1 bg-gray-200 rounded-full"
                              >+</button>
                              <span className="text-sm">{l.liters}</span>
                            </div>
                            <span className="font-semibold text-sm">{l.total}: {computeTotalLiters(data)}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
              {/* Add item section */}
              <div className="rounded-xl shadow-md p-4 bg-yellow-50 space-y-2">
                <div className="font-semibold">{l.addItem}</div>
                <div className="flex flex-wrap items-center gap-2">
                  <input
                    type="text"
                    value={newItemName}
                    onChange={(e) => setNewItemName(e.target.value)}
                    placeholder={l.namePlaceholder}
                    className="flex-1 border border-gray-300 rounded-lg px-3 py-1"
                  />
                    <select
                    value={newItemCat}
                    onChange={(e) => setNewItemCat(e.target.value)}
                    className="border border-gray-300 rounded-lg px-2 py-1"
                  >
                    <option value="cold">{l.cold}</option>
                    <option value="hot">{l.hot}</option>
                    <option value="nines">{l.nines}</option>
                    <option value="custom">{l.custom}</option>
                  </select>
                  <button
                    onClick={handleAddItem}
                    className="px-4 py-1 bg-green-500 text-white rounded-lg"
                  >{l.add}</button>
                </div>
              </div>
              {/* Share button */}
              <div className="text-center mt-6">
                <button
                  onClick={handleShare}
                  className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full shadow-md"
                >{l.share}</button>
              </div>
            </div>
          </div>
        );
      }

      const rootEl = document.getElementById('root');
      const root = ReactDOM.createRoot(rootEl);
      root.render(<InventoryForm />);
    </script>
  </body>
</html>